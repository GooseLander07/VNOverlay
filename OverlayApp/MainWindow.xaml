<Window x:Class="OverlayApp.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:OverlayApp"
        mc:Ignorable="d"
        Title="VNTextMiner" Height="150" Width="800"
        WindowStyle="None" AllowsTransparency="True" Background="#CC1E1E1E"
        Topmost="True" ResizeMode="CanResizeWithGrip"
        MouseDown="Window_MouseDown" Loaded="Window_Loaded" Closed="Window_Closed">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <!-- Simple style for the scrollbar to blend in -->
        <Style TargetType="ScrollBar">
            <Setter Property="Background" Value="#252526"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="25"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Toolbar / Header -->
        <Border Grid.Row="0" Background="#2D2D30" MouseDown="Window_MouseDown">
            <Grid>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" Margin="5,0,0,0">
                    <TextBlock Text="VNTextMiner" Foreground="#CCCCCC" VerticalAlignment="Center" FontWeight="Bold"/>
                    <TextBlock x:Name="StatusText" Text="Initializing..." Foreground="Gray" Margin="10,0,0,0" VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,5,0">
                    <Button Content="⚙" Click="Settings_Click" Background="Transparent" Foreground="White" BorderThickness="0" Cursor="Hand" Width="25"/>
                    <Button Content="✕" Click="Close_Click" Background="Transparent" Foreground="#FF5555" BorderThickness="0" Cursor="Hand" Width="25"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Text Area -->
        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
            <ItemsControl x:Name="TextContainer" Margin="5">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Button Click="Word_Click" Tag="{Binding}" Margin="1" 
                                Background="Transparent" BorderThickness="0" Cursor="Hand">
                            <Button.Template>
                                <ControlTemplate TargetType="Button">
                                    <Border Background="{TemplateBinding Background}" CornerRadius="3" Padding="2">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Surface}" FontSize="18" Foreground="White" FontWeight="SemiBold"/>
                                        </StackPanel>
                                    </Border>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- Settings Panel (Overlay) -->
        <Border x:Name="SettingsPanel" Grid.Row="1" Background="#252526" Padding="10" Visibility="Collapsed" VerticalAlignment="Top" HorizontalAlignment="Right" Margin="0,0,5,0" BorderBrush="#3F3F46" BorderThickness="1" CornerRadius="0,0,5,5">
            <StackPanel Width="200">
                <TextBlock Text="Settings" FontWeight="Bold" Foreground="White" Margin="0,0,0,10"/>

                <CheckBox x:Name="ChkPause" Content="Pause Clipboard Monitor" Foreground="White" Margin="0,0,0,10" Checked="ChkPause_Checked" Unchecked="ChkPause_Checked"/>

                <TextBlock Text="Anki Deck Name:" Foreground="Gray"/>
                <TextBox x:Name="TxtDeck" Text="Japanese::VN" Background="#333" Foreground="White" BorderThickness="0" Padding="3" Margin="0,0,0,10"/>

                <!-- Transparency Slider -->
                <TextBlock Text="Background Opacity:" Foreground="Gray" Margin="0,5,0,0"/>
                <Grid Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="30"/>
                    </Grid.ColumnDefinitions>
                    <Slider x:Name="OpacitySlider" Minimum="0.1" Maximum="1.0" Value="0.8" 
                            TickFrequency="0.1" IsSnapToTickEnabled="True"
                            ValueChanged="OpacitySlider_ValueChanged"/>
                    <TextBlock Text="{Binding ElementName=OpacitySlider, Path=Value, StringFormat=N1}" 
                               Grid.Column="1" Foreground="White" HorizontalAlignment="Right" VerticalAlignment="Center"/>
                </Grid>

                <Button Content="Test Anki Connection" Click="TestAnki_Click" Background="#333" Foreground="White" BorderThickness="0" Padding="5"/>
                <TextBlock x:Name="AnkiStatus" Margin="5,5,0,0" HorizontalAlignment="Center" FontSize="10"/>
            </StackPanel>
        </Border>

        <!-- Dictionary Popup -->
        <Popup x:Name="DictPopup" Placement="MousePoint" StaysOpen="False" AllowsTransparency="True">
            <Border Background="#1E1E1E" BorderBrush="#333" BorderThickness="1" CornerRadius="5" MaxWidth="500" MaxHeight="400">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" ShadowDepth="3" Opacity="0.5"/>
                </Border.Effect>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="350">
                        <ItemsControl x:Name="PopEntries" AlternationCount="2">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="10" BorderBrush="#333" BorderThickness="0,0,0,1">
                                        <StackPanel>
                                            <!-- Header -->
                                            <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                                                <TextBlock Text="{Binding Headword}" Foreground="#61AFEF" FontSize="24" FontWeight="Bold" Margin="0,0,10,0"/>
                                                <TextBlock Text="{Binding Reading}" Foreground="#98C379" FontSize="18" VerticalAlignment="Bottom"/>
                                            </StackPanel>

                                            <!-- Definition (FlowDocument) -->
                                            <FlowDocumentScrollViewer Document="{Binding DefinitionDocument}" 
                                                                      VerticalScrollBarVisibility="Disabled" 
                                                                      IsToolBarVisible="False"
                                                                      Background="Transparent"
                                                                      Margin="-5,0,0,0" />
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <Button Grid.Row="1" Click="AddToAnki_Click" 
                            Background="#43A047" Foreground="White" BorderThickness="0" Padding="10"
                            FontWeight="Bold" Cursor="Hand">
                        + Add Current to Anki
                    </Button>
                </Grid>
            </Border>
        </Popup>

    </Grid>
</Window>